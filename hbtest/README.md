# 实时心率检测网站

基于PPG（光电容积脉搏波描记法）原理的Web心率检测应用，通过分析人脸血液循环引起的微小颜色变化来实时计算心率。这是一个纯前端实现的项目，无需后端服务器，可直接在浏览器中运行。

## 🌟 功能特点

- 🎥 **实时视频处理**: 30fps摄像头视频流，确保足够的时间分辨率
- 🔍 **智能人脸检测**: 使用face-api.js自动检测和跟踪人脸
- 📊 **精确心率计算**: 基于FFT频域分析的心率检测算法
- 📈 **实时波形显示**: 心率波形图可视化，直观观察信号质量
- 🎯 **信号质量评估**: 实时评估检测信号的质量和稳定性
- ⏱️ **校准机制**: 15秒校准期 + 5秒延时显示，确保准确性
- 📱 **响应式设计**: 完美适配桌面端和移动端设备
- 🛡️ **隐私保护**: 完全本地处理，不上传任何数据

## 🔬 技术原理

### PPG（光电容积脉搏波描记法）

PPG是一种非侵入式的光学测量技术，其工作原理：

1. **血液循环的光学特性**: 心脏泵血时，血管中的血液量会周期性变化
2. **颜色变化检测**: 血液量变化导致皮肤颜色产生微小的周期性变化
3. **绿光敏感性**: 血红蛋白对绿光最敏感，因此主要分析绿色通道数据
4. **频域分析**: 通过FFT将时域信号转换为频域，找到心率对应的主频率

### 详细信号处理流程

```
摄像头视频流 (30fps)
    ↓
人脸检测 (face-api.js)
    ↓
ROI提取 (完整人脸区域)
    ↓
RGB信号提取 (绿色通道平均值)
    ↓
预处理 (异常值去除)
    ↓
带通滤波 (0.7-3.5Hz)
    ↓
移动平均滤波 (平滑处理)
    ↓
FFT分析 (1024点)
    ↓
峰值检测 (找到主频率)
    ↓
BPM转换 (频率 × 60)
    ↓
稳定性检查 (标准差阈值)
    ↓
延时显示 (5秒延迟)
```

## 📁 项目结构

```
hbtest/
├── index.html                   # 主页面
├── style.css                   # 样式文件
├── js/
│   ├── app.js                  # 应用主控制器
│   ├── heart-rate-detector.js  # 心率检测核心类
│   ├── signal-processing.js    # 信号处理算法
│   └── fft.js                  # FFT快速傅里叶变换实现
├── README.md                   # 项目说明
└── CLAUDE.md                   # 开发指南
```

### 核心模块说明

#### 1. HeartRateDetector (heart-rate-detector.js)
- **功能**: 核心检测逻辑，协调各个模块
- **职责**: 
  - 摄像头管理
  - 人脸检测和ROI提取
  - RGB信号采集
  - 结果显示和可视化

#### 2. SignalProcessor (signal-processing.js)
- **功能**: 信号处理和心率计算
- **职责**:
  - 信号滤波（带通滤波、移动平均）
  - 异常值检测和去除
  - FFT分析和峰值检测
  - 心率计算和验证

#### 3. FFT (fft.js)
- **功能**: 快速傅里叶变换实现
- **职责**:
  - 时域到频域转换
  - 幅度谱计算
  - 预计算优化（位反转表、三角函数表）

## 🚀 使用说明

### 快速开始

1. **启动应用**: 在现代浏览器中打开 `index.html`
2. **授权摄像头**: 点击"开始检测"并授权摄像头访问
3. **调整位置**: 确保脸部完全在摄像头视野内
4. **等待校准**: 系统会显示"校准中...进度%"，需要15秒
5. **稳定测量**: 校准完成后，保持静止，心率值会在5秒后显示
6. **查看结果**: 观察心率数值、信号质量和实时波形图

### 最佳使用条件

- **光照条件**: 均匀、充足的自然光或白光
- **环境要求**: 避免阳光直射和强烈阴影
- **姿势要求**: 保持脸部正对摄像头，尽量减少移动
- **距离要求**: 距离摄像头30-60厘米为佳
- **时间要求**: 至少测量30秒以获得准确结果

### 界面说明

- **视频预览**: 显示摄像头画面，绿色框表示检测到的人脸，红色框表示ROI采样区域
- **心率显示**: 大号数字显示当前心率，校准期间显示进度
- **信号质量**: 实时评估信号质量（优秀/良好/一般/较差）
- **波形图**: 显示最近5秒的心率信号波形
- **控制按钮**: 开始/停止检测

## 🌐 浏览器兼容性

### 支持的浏览器
- **Chrome**: 56+ (推荐)
- **Firefox**: 52+
- **Safari**: 11+
- **Edge**: 79+

### 技术要求
- **WebRTC**: 支持 getUserMedia API
- **Canvas**: 支持 Canvas 2D API
- **ES6**: 支持现代JavaScript语法
- **HTTPS**: 生产环境需要HTTPS协议

### 移动端支持
- **iOS Safari**: 11+
- **Android Chrome**: 56+
- **注意**: 移动端可能由于摄像头分辨率和处理能力限制，效果略有差异

## ⚙️ 技术参数

### 算法参数
- **采样率**: 30fps
- **数据缓冲**: 20秒历史数据
- **滤波范围**: 0.7-3.5Hz (对应42-210 BPM)
- **FFT窗口**: 1024点，提供高频率分辨率
- **窗口函数**: 汉宁窗，减少频谱泄漏
- **校准时间**: 15秒，建立稳定基线
- **显示延迟**: 5秒，确保计算准确性

### 性能优化
- **预计算**: FFT位反转表和三角函数表
- **缓冲管理**: 自动清理过期数据
- **异常处理**: 多层异常值检测和处理
- **稳定性检查**: 标准差阈值验证

## 📊 准确性说明

### 检测范围
- **心率范围**: 45-200 BPM
- **最适范围**: 60-120 BPM（静息心率）
- **精度**: ±5 BPM（理想条件下）

### 影响因素
- **光照条件**: 强烈影响检测准确性
- **皮肤颜色**: 深色皮肤可能需要更强光照
- **运动状态**: 静止状态下准确性最高
- **环境干扰**: 避免光照变化和背景移动

### 医疗免责声明
⚠️ **重要提醒**: 
- 本应用仅供娱乐和学习使用
- 不能替代专业医疗设备
- 不应用于医疗诊断或治疗决策
- 如有健康问题，请咨询专业医生

## 🛠️ 开发说明

### 本地开发
```bash
# 克隆项目
git clone <repository-url>

# 进入项目目录
cd hbtest

# 使用本地服务器（推荐）
python -m http.server 8000
# 或使用 Node.js
npx http-server

# 浏览器访问
http://localhost:8000
```

### 部署说明
- **静态托管**: 可部署到任何静态文件托管服务
- **HTTPS要求**: 生产环境必须使用HTTPS
- **CDN优化**: 可使用CDN加速face-api.js加载

### 自定义配置
可以通过修改以下参数来调整检测行为：
```javascript
// 在 heart-rate-detector.js 中
this.calibrationPeriod = 15000; // 校准时间
this.displayDelay = 5000;       // 显示延迟

// 在 signal-processing.js 中
this.bufferSize = sampleRate * 20; // 缓冲区大小
this.fft = new FFT(1024);          // FFT窗口大小
```

## 🔧 故障排除

### 常见问题

1. **无法访问摄像头**
   - 检查浏览器权限设置
   - 确保使用HTTPS或localhost
   - 确认摄像头未被其他应用占用

2. **检测不准确**
   - 改善光照条件
   - 保持脸部稳定
   - 等待完整校准期结束

3. **信号质量差**
   - 调整与摄像头的距离
   - 检查光源是否稳定
   - 避免背景干扰

4. **性能问题**
   - 关闭不必要的浏览器标签
   - 确保硬件加速开启
   - 使用性能更好的设备

## 📈 未来改进

- [ ] 多人同时检测
- [ ] 心率变异性分析
- [ ] 数据导出功能
- [ ] 移动端优化
- [ ] 更多生理参数检测
- [ ] 机器学习算法优化

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进这个项目！

## 📄 许可证

本项目采用MIT许可证 - 详见LICENSE文件

## 🙏 致谢

- face-api.js 提供人脸检测功能
- Web APIs 提供摄像头访问
- FFT算法实现参考
- PPG技术原理研究

---

**开发者**: Claude Code  
**最后更新**: 2024年  
**版本**: 1.0.0